---
title: "Swimming downstream: statistical analysis of differential transcript usage following Salmon quantification"
author:
- name: Michael I. Love
  affiliation: 
  - Department of Biostatistics, UNC-Chapel Hill, Chapel Hill, NC, US
  - Department of Genetics, UNC-Chapel Hill, Chapel Hill, NC, US
- name: Rob Patro
  affiliation: Department of Computer Science, Stony Brook University
date: 5 June, 2018
vignette: >
  %\VignetteIndexEntry{RNA-seq workflow for differential transcript usage following Salmon quantification}
  %\VignetteEngine{knitr::rmarkdown}
abstract: |
  RNA-seq workflow for differential transcript usage following Salmon quantification.
keywords: RNA-seq, workflow, differential transcript usage, Salmon, DRIMSeq, DEXSeq, stageR, tximport
bibliography: bibliography.bib
output: BiocWorkflowTools::f1000_article
---

<!-- to compile this: 
  rmarkdown::render("rnaseqDTU.Rmd")
-->

<!-- a list of all required libraries:
  reqlibs = sub(".*library\\((.*?)\\).*","\\1",grep("library\\(",readLines("rnaseqDTU.Rmd"),value=TRUE))
  find.package(reqlibs)
-->

```{r style, echo=FALSE, message=FALSE, warning=FALSE, results="asis"}
library(knitr)
library(rmarkdown)
opts_chunk$set(message=TRUE, warning=FALSE, error=FALSE, 
               cache=TRUE, fig.width=5, fig.height=5)
```

**R version**: `r R.version.string`

**Bioconductor version**: `r BiocInstaller::biocVersion()`

<!-- fix this to rnaseqDTU later -->
**Package**: `r packageVersion("DRIMSeq")`

# Introduction

RNA-seq experiments can be analyzed to detect changes across groups of
samples in total gene expression, i.e. the total number of transcripts
produced by all isoforms of a gene, and additionally differences in
transcript usage within a gene. If the number of expressed transcripts
switches among two or more isoforms of a gene, then the total gene
expression may not change by a detectable amount, but such
differential transcript usage is of interest to biological and
biomedical researchers. While many packages and workflows in the
Bioconductor project address differential gene expression, there are
fewer guides for performing a differential transcript usage analysis,
which provides critical and complementary information to a the
gene-level analysis. Some of the existing packages and vignettes that 
can be used to detect differential transcript usage include *BitSeq*, 
*DEXSeq* (originally designed for differential exon usage), `diffSpliceDGE` 
from the *edgeR* package, `diffSplice` from the *limma* package, *DRIMSeq*, 
*stageR*, and *IsoformSwitchAnalyzeR*. 
Others can be found at the following link: 
<https://bioconductor.org/packages/release/BiocViews.html#___DifferentialSplicing>

Previously, some of the developers of the Bioconductor packages
*edgeR* and *DESeq2* (cite) have collaborated to develop the
*tximport* package (cite) for summarizing the output of fast
transcript-level quantifiers, such as *Salmon*, *Sailfish*, and
*kallisto* (cite). The *tximport* package focuses on preparing
estimated transcript-level quantities, counts, abundances and
effective transcript lengths, for gene-level statistical analysis
using *edgeR*, *DESeq* or *limma-voom* (cite). *tximport* produces an
offset matrix to accompany gene-level counts, that accounts for
various RNA-seq biases (cite Salmon) as well as differences in
transcript usage among transcripts of different length that would bias
an estimator of fold change based on the gene-level counts (cite
Trapnell). *tximport* can alternatively produce a matrix of data that
is roughly on the scale of counts, by scaling abundances to add up to
the total number of reads, which directly corrects for technical
biases and differential transcript usage across samples, obviating the
need for the accompanying offset matrix. 

Complementary to an analysis of differential gene expression, one can
use *tximport* to import transcript-level counts, and then pass these
counts to packages such as *DRIMSeq* or *DEXSeq* for statistical
analysis of differential transcript usage. Following a
transcript-level analysis, one can aggregate evidence of differential
transcript usage to the gene-level. The *stageR* package in
Bioconductor provides a statistcal framework for screening for
differential transcript usage using gene-level adjusted p-values,
followed by confirmation of which transcripts are differential using
transcript-level adjusted p-values (cite). The method provides
_overall false discovery rate_ error control for such a two-stage
procedure, which will be discussed in more detail later in the
workflow. We believe that this represents a principled approach to
analyzing transcript usage changes, as the  methods can be evaluated
against a target error rate in a manner that mimics how the methods
would actually be used in practice. That is, following rejection of
the null hypothesis at the gene-level, investigators would likely
desire to know which transcripts within a gene participated in the
differential usage. 

Here we provide a simple workflow for detecting
differential transcript abundance using Bioconductor packages,
following quantification of transcript abundance using the *Salmon*
method. This workflow includes live, runnable code chunks for analysis
using the *DRIMSeq* and *DEXSeq*, as well as for performing stage-wise
testing of differential transcript usage using the *stageR*
package. For the workflow, we use data which is simulated with
experimental parameters estimated from the GEUVADIS dataset, so that
we can also evaluate the performance of methods for differential
transcript usage, as well as differential gene and transcript
expression.

# Methods

## Simulation

First we describe details of the simulated data, which will be used in
the following workflow. Understanding the details of the
simulation will be useful for assessing the methods in the later sections.
All of the code used to simulate RNA-seq experiments and write
paired-end reads can be found at the following
link: <https://github.com/mikelove/swimdownsim>. *alpine* was used to
estimate realistic fragment GC bias from 12 samples from the GEUVADIS
project from the same center (cite alpine and GEUVADIS). *DESeq2* was
used to estimate mean and dispersion parameters for a Negative
Binomial distribution for gene-level counts for 462 GEUVADIS samples
provided by the *recount2* project (cite DESeq2, recounts2).
*polyester* was used to simulate paired-end RNA-seq reads for two
groups of 12 samples each, with realistic fragment GC bias, and with
dispersion on transcript-level counts following the joint distribution
of mean and dispersion values estimated from the GEUVADIS samples. The
first sample for group 1 and the first sample for group 2 followed the
realistic GC bias profile of the same sample, and so on for all 12
samples. This pairing of the samples was used to generate balanced
data, but not used in the statistical analysis. The baseline for
transcript abundances was taken from Salmon estimates for a single
sample of the GEUVADIS project (cite Salmon). *countsimQC* was used to
examine the properties of the simulation relative to the dataset used
for parameter estimation, and the full report can be accessed at the
following link: <https://github.com/mikelove/swimdownsim/countsimqc>
(cite countsimqc).

Differential expression across two groups was generated as follows:
70% of the genes were set as "null genes", where abundance was not
changed across two groups. For 10% of genes, all isoforms were
differentially expressed at a log fold change between 1 and 2.58. This
set of genes and transcripts were classified as "DGE", differential
gene expression, but did not count as "DTU", differential transcript
usage. To simulate balanced differential expression, randomly one of
the two groups was chosen to be the baseline, and the other group
would have its counts multiplied by the fold change. For 10% of genes,
a single expressed isoform was differentially expressed at a log fold
change between 1 and 2.58. This set of genes was termed "DTE",
differential transcript expression. If the chosen transcript was the
only expressed isoform of a gene, this counted as DGE and not DTU,
but if there were other isoforms which are expressed, such genes
counted for both DGE and DTU, as the proportion of expression among
the isoforms was affected. For 10% of genes, differential transcript
usage was constructed by exchanging the abundance of two expressed
isoforms, or if only one isoform was expressed, exchanging the
abundance of the expressed isoform with a non-expressed one. Such
genes counted for DTU, but not for DGE.

```{r ma-simulated, echo=FALSE, dev="png", out.width="50%", fig.cap = "MA plot of simulated abundances. Each point depicts a transcript, with the average of log2 abundance (TPM) on the x-axis and the difference between the two groups on the y-axis."}
load("simulate.rda")
library(rafalib)
bigpar()
pc <- 1
col <- rep(8, nrow(tpms))
col[iso.dge] <- 1
col[iso.dte] <- 2
col[iso.dtu] <- 3
maplot(log2(tpms[,1]+pc), log2(tpms[,2]+pc),
       n=nrow(tpms), curve.add=FALSE,
       col=col, cex=.25, pch=20)
legend("bottomright",
       c("DGE","DTE","DTU","null"),
       col=c(1:3,8), pch=20, bty="n")
```

## Operation

This workflow was designed to work with R 3.5 or higher, and the
*DRIMSeq*, *DEXSeq*, *stageR* and *tximport* packages for Bioconductor
version 3.7 or higher. Bioconductor packages should always be
installed following the [official instructions](https://bioconductor.org/install).
The workflow uses a subset of all genes to speed
up the analysis, but the Bioconductor packages can easily be run for
this dataset on all human genes on a laptop in less than an
hour. Timing for the various packages is included within each section.

# Salmon quantification

We used *Salmon* version 0.10.0 to quantify abundance and effective
lengths for all of the 24 simulated samples. For this workflow, we
will use the first six samples from each group. We quantified against
the [GENCODE](https://www.gencodegenes.org/releases/current.html)
human annotation version 28, which was the same reference used to
generate the simulated reads. We used the transcript sequences FASTA
file which contains "Nucleotide sequences of all transcripts on the
reference chromosomes". When downloading the FASTA file, it is useful
to download the corresponding GTF file, as this will be used in later
sections. 

To build the *Salmon* index, we used the following command:

```
salmon index -t gencode.v28.transcripts.fa -i gencode.v28_salmon-0.10.0
```

To quantify each sample, we used the following command, which uses 6
threads, and performs fragment GC bias modeling. The library type is
specified by `-l IU` and is discussed at this link:
<http://salmon.readthedocs.io/en/latest/library_type.html>. The latest
versions of Salmon can automatically detect the library type by
setting `-l A`. Such a command can be automated in a bash loop using
bash variables, or one can use more advanced workflow management
systems such as Snakemake or Nextflow (cite).

```
salmon quant -p 6 -i gencode.v28_salmon-0.10.0 -l IU \
      --gcBias -o sample -1 sample_1.fa.gz -2 sample_2.fa.gz
```

# Importing counts into R/Bioconductor

We can use *tximport* to import the estimated counts, abundances and
effective transcript lengths into R. We recommend to keep a CSV file
that keeps track of the sample identifiers and any relevant variables,
e.g. condition, time point, batch, and so on. Here we have made a
sample CSV file which records which sample is condition 1 and which is
condition 2. The columns of this CSV can have any names, although
`sample_id` will be used later by *DRIMSeq*, and so using this column
name allows us to pass this *data.frame* directly to *DRIMSeq* at a
later step.

```{r}
samps <- read.csv("samples.csv")
head(samps)
samps$condition <- factor(samps$condition)
table(samps$condition)
files <- file.path("/path/to/dir", samps$sample_id, "quant.sf")
names(files) <- samps$sample_id
files
```

We can then import transcript-level counts using the following
call. Here we suggest to generate counts from abundance, using the
`scaledTPM` method described by Soneson et al (cite). As described
above, the `countsFromAbundance` option of *tximport* uses estimated
abundances to generate roughly count-scaled data, such that each
column will sum to the number of reads generated for that library. One
reason we suggest to use `scaledTPM` for differential transcript usage
is that the estimated proportions that will be fit by *DRIMSeq* in
following sections will correspond to proportions of abundance. 

The following code chunk is not evaluated, but instead we will load a
pre-constructed matrix of counts.

```{r eval=FALSE}
library(tximport)
txi <- tximport(files, type="salmon", txOut=TRUE,
                countsFromAbundance="scaledTPM")
cts <- txi$counts
cts <- cts[rowSums(cts) > 0,]
```

If we used the estimated counts themselves,
or `lengthScaledTPM`, then a change in transcript usage between
transcripts of different length could result in a changed total count
for the gene, even if there is no change in total gene
expression. While this could be corrected by an offset, this is not
easily implemented in the current packages. While this workflow only
considers existing software features, we are considering developing a new
`countsFromAbundance` method which would scale abundance for all
transcripts of a gene by a fixed gene length, then each sample by its
number of reads, therefore balancing between the benefits of
`scaledTPM` and `lengthScaledTPM`.

# Transcript-to-gene mapping

Bioconductor offers numerous approaches for building a *TxDb* object,
a transcript database that can be used to link transcripts to genes.
We used the following unevaluated code chunks to generate a *TxDb*, and
then we will use the *data.frame* called `txdf` in following
sections. The version 28 human GTF file was downloaded from the
GENCODE website.

```{r eval=FALSE}
library(GenomicFeatures)
gtf <- "gencode.v28.annotation.gtf.gz"
txdb.filename <- "gencode.v28.annotation.sqlite"
txdb <- makeTxDbFromGFF(gtf)
saveDb(txdb, txdb.filename)
```

Once the *TxDb* database has been saved, it can be quickly reloaded:

```{r eval=FALSE}
txdb <- loadDb(txdb.filename)
txdf <- select(txdb, keys(txdb, "GENEID"), "TXNAME", "GENEID")
tab <- table(txdf$GENEID)
txdf$ntx <- tab[match(txdf$GENEID, names(tab))]
```

# DRIMSeq

```{r}
load("salmon_cts.rda")
head(cts)
```

```{r}
head(txdf)
```

```{r}
all(rownames(cts) %in% txdf$TXNAME)
txdf <- txdf[match(rownames(cts),txdf$TXNAME),]
```

```{r}
all(rownames(cts) == txdf$TXNAME)
counts <- data.frame(gene_id=txdf$GENEID,
                     feature_id=txdf$TXNAME,
                     cts)
```

```{r}
library(DRIMSeq)
d <- dmDSdata(counts=counts, samples=samps)
```

```{r}
n <- 12
n.small <- 6
d <- dmFilter(d,
              min_samps_feature_expr=n.small, min_feature_expr=10,
              min_samps_feature_prop=n.small, min_feature_prop=0.1,
              min_samps_gene_expr=n, min_gene_expr=10)
d
```

```{r}
design_full <- model.matrix(~condition, data=DRIMSeq::samples(d))
colnames(design_full)
```

```{r}
d <- d[1:250,]
7750 / 250
```

```{r}
set.seed(1)
system.time({
  d <- dmPrecision(d, design=design_full)
  d <- dmFit(d, design=design_full)
  d <- dmTest(d, coef="condition2")
})
```

# stageR follwing DRIMSeq

# DEXSeq

```{r}
library(DEXSeq)
sample.data <- DRIMSeq::samples(d)
count.data <- round(as.matrix(counts(d)[,-c(1:2)]))
dxd <- DEXSeqDataSet(countData=count.data,
                     sampleData=sample.data,
                     design=~sample + exon + condition:exon,
                     featureID=counts(d)$feature_id,
                     groupID=counts(d)$gene_id)
```

```{r}
system.time({
  dxd <- estimateSizeFactors(dxd)
  dxd <- estimateDispersions(dxd, quiet=TRUE)
  dxd <- nbinomLRT(dxd, reduced=~sample + exon)
})
```

# stageR follwing DEXSeq

# SUPPA2

# Evaluation of methods for DTU

# Differential gene expression

Make a plot of transcript usage over gene expression.

# Evaluation of methods for DGE

# Evaluation of methods for DTE

# Example of references

An example reference is @Patro2017Salmon and it also looks like [@Patro2017Salmon].

# References
